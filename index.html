<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç»œå»¶è¿Ÿç›‘æµ‹ç³»ç»Ÿ - å®Œå…¨å¯ç”¨ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        .main-content {
            padding: 30px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #eef2f7;
        }
        .card-title {
            color: #2d3748;
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
        }
        select, input, button {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
            background: white;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-success { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
        .btn-danger { background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); }
        .btn-warning { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); }
        .btn-info { background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); }
        
        .status-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e2e8f0;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #a0aec0;
        }
        .status-dot.active {
            background: #48bb78;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(72, 187, 120, 0); }
            100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
        }
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin: 25px 0;
        }
        .result-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        .result-card h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }
        .latency {
            font-size: 3.5rem;
            font-weight: 800;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .latency.good { color: #38a169; }
        .latency.medium { color: #d69e2e; }
        .latency.poor { color: #e53e3e; }
        .latency.unknown { color: #a0aec0; }
        .node-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .node-selector select {
            flex: 1;
        }
        .node-selector button {
            padding: 0 20px;
            flex-shrink: 0;
        }
        .chart-container {
            height: 300px;
            margin: 25px 0;
            position: relative;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #718096;
            transition: all 0.3s;
        }
        .tab:hover {
            color: #4a5568;
        }
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .tab-content.active {
            display: block;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .history-table th {
            background: #4a5568;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        .history-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        .history-table tr:hover {
            background: #f7fafc;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .modal h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        .log-container {
            height: 200px;
            overflow-y: auto;
            background: #1a202c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #2d3748;
            display: flex;
            gap: 10px;
        }
        .log-time {
            color: #a0aec0;
            flex-shrink: 0;
        }
        .log-message {
            flex: 1;
        }
        .log-info { color: #63b3ed; }
        .log-success { color: #68d391; }
        .log-warning { color: #f6e05e; }
        .log-error { color: #fc8181; }
        
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: #2d3748;
            margin: 5px 0;
        }
        .stat-label {
            font-size: 14px;
            color: #718096;
        }
        .custom-node-input {
            display: none;
            margin-top: 15px;
            animation: slideDown 0.3s;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-bar {
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 25px;
            color: #718096;
            font-size: 14px;
            border-top: 1px solid #e2e8f0;
        }
        .node-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .node-item {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .node-item:hover {
            background: #f7fafc;
        }
        .node-info {
            flex: 1;
        }
        .node-name {
            font-weight: 600;
            color: #2d3748;
        }
        .node-address {
            font-size: 12px;
            color: #718096;
            margin-top: 3px;
        }
        .node-actions {
            display: flex;
            gap: 5px;
        }
        .node-actions button {
            padding: 6px 12px;
            font-size: 13px;
        }
        
        @media (max-width: 768px) {
            .container { border-radius: 10px; }
            .main-content { padding: 20px; }
            .card { padding: 20px; }
            .control-grid { grid-template-columns: 1fr; }
            .btn-group { grid-template-columns: 1fr; }
            .results-grid { grid-template-columns: 1fr; }
            .tab { padding: 10px 15px; font-size: 14px; }
            .modal-content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸŒ ç½‘ç»œå»¶è¿Ÿç›‘æµ‹ç³»ç»Ÿ</h1>
            <div class="subtitle">å®æ—¶æµ‹é‡ä¸­å›½å¤§é™†ä¸å°æ¹¾åœ°åŒºç½‘ç»œè¿æ¥è´¨é‡</div>
        </header>

        <div class="main-content">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="card">
                <h2 class="card-title">âš™ï¸ æ§åˆ¶é¢æ¿</h2>
                
                <div class="control-grid">
                    <div class="form-group">
                        <label>æ‚¨çš„æ‰€åœ¨åœ°</label>
                        <select id="userLocation">
                            <option value="">è¯·é€‰æ‹©æ‰€åœ¨åœ°</option>
                            <optgroup label="ä¸­å›½å¤§é™†">
                                <option value="åŒ—äº¬">åŒ—äº¬å¸‚</option>
                                <option value="ä¸Šæµ·">ä¸Šæµ·å¸‚</option>
                                <option value="å¹¿å·" selected>å¹¿å·å¸‚</option>
                                <option value="æ·±åœ³">æ·±åœ³å¸‚</option>
                                <option value="æ­å·">æ­å·å¸‚</option>
                                <option value="æˆéƒ½">æˆéƒ½å¸‚</option>
                            </optgroup>
                            <optgroup label="å°æ¹¾åœ°åŒº">
                                <option value="å°åŒ—">å°åŒ—å¸‚</option>
                                <option value="æ–°åŒ—">æ–°åŒ—å¸‚</option>
                                <option value="æ¡ƒå›­">æ¡ƒå›­å¸‚</option>
                                <option value="å°ä¸­">å°ä¸­å¸‚</option>
                                <option value="é«˜é›„">é«˜é›„å¸‚</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>æµ‹è¯•é¢‘ç‡</label>
                        <select id="testFrequency">
                            <option value="30">æ¯30ç§’</option>
                            <option value="60" selected>æ¯1åˆ†é’Ÿ</option>
                            <option value="300">æ¯5åˆ†é’Ÿ</option>
                            <option value="600">æ¯10åˆ†é’Ÿ</option>
                            <option value="1800">æ¯30åˆ†é’Ÿ</option>
                            <option value="3600">æ¯1å°æ—¶</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>è‡ªåŠ¨ä¿å­˜</label>
                        <select id="autoSave">
                            <option value="3600">æ¯å°æ—¶</option>
                            <option value="28800" selected>æ¯8å°æ—¶</option>
                            <option value="86400">æ¯å¤©</option>
                            <option value="0">ä¸è‡ªåŠ¨ä¿å­˜</option>
                        </select>
                    </div>
                </div>
                
                <div class="status-bar">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">å‡†å¤‡å¼€å§‹æµ‹è¯•</span>
                    <div style="margin-left: auto; display: flex; gap: 15px;">
                        <span id="lastTest">ä¸Šæ¬¡: -</span>
                        <span id="nextTest">ä¸‹æ¬¡: -</span>
                    </div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                
                <div class="btn-group">
                    <button id="startBtn" class="btn-primary">â–¶ å¼€å§‹è‡ªåŠ¨æµ‹è¯•</button>
                    <button id="stopBtn" class="btn-danger" disabled>â¸ åœæ­¢æµ‹è¯•</button>
                    <button id="testNowBtn" class="btn-success">âš¡ ç«‹å³æµ‹è¯•</button>
                    <button id="exportBtn" class="btn-info">ğŸ’¾ å¯¼å‡ºæ•°æ®</button>
                    <button id="importBtn" class="btn-warning">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
                    <button id="manageNodesBtn" class="btn-primary">ğŸŒ ç®¡ç†èŠ‚ç‚¹</button>
                </div>
            </div>
            
            <!-- å®æ—¶ç»“æœ -->
            <div class="card">
                <h2 class="card-title">ğŸ“Š å®æ—¶å»¶è¿Ÿ</h2>
                <div class="results-grid">
                    <!-- å¤§é™†èŠ‚ç‚¹ç»“æœ -->
                    <div class="result-card" id="mainlandCard">
                        <h3>ä¸­å›½å¤§é™†èŠ‚ç‚¹</h3>
                        <div class="latency unknown" id="mainlandLatency">--</div>
                        <div id="mainlandStatus" style="color: #718096; margin-bottom: 15px;">ç­‰å¾…æµ‹è¯•...</div>
                        <div class="node-selector">
                            <select id="mainlandNodeSelect">
                                <!-- èŠ‚ç‚¹å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                            </select>
                            <button onclick="testSingleNode('mainland')">æµ‹è¯•</button>
                        </div>
                        <div class="custom-node-input" id="mainlandCustom">
                            <input type="text" id="mainlandCustomInput" placeholder="è¾“å…¥IPæˆ–åŸŸåï¼Œå¦‚: 8.8.8.8" 
                                   style="margin-bottom: 10px;">
                            <button onclick="saveCustomNode('mainland')" style="width: 100%;">ä¿å­˜èŠ‚ç‚¹</button>
                        </div>
                    </div>
                    
                    <!-- å°æ¹¾èŠ‚ç‚¹ç»“æœ -->
                    <div class="result-card" id="taiwanCard">
                        <h3>å°æ¹¾åœ°åŒºèŠ‚ç‚¹</h3>
                        <div class="latency unknown" id="taiwanLatency">--</div>
                        <div id="taiwanStatus" style="color: #718096; margin-bottom: 15px;">ç­‰å¾…æµ‹è¯•...</div>
                        <div class="node-selector">
                            <select id="taiwanNodeSelect">
                                <!-- èŠ‚ç‚¹å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                            </select>
                            <button onclick="testSingleNode('taiwan')">æµ‹è¯•</button>
                        </div>
                        <div class="custom-node-input" id="taiwanCustom">
                            <input type="text" id="taiwanCustomInput" placeholder="è¾“å…¥IPæˆ–åŸŸåï¼Œå¦‚: 168.95.1.1" 
                                   style="margin-bottom: 10px;">
                            <button onclick="saveCustomNode('taiwan')" style="width: 100%;">ä¿å­˜èŠ‚ç‚¹</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç»Ÿè®¡æ•°æ® -->
            <div class="card">
                <h2 class="card-title">ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯</h2>
                <div class="statistics-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalTests">0</div>
                        <div class="stat-label">æ€»æµ‹è¯•æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="successRate">100%</div>
                        <div class="stat-label">æˆåŠŸç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgMainland">-- ms</div>
                        <div class="stat-label">å¤§é™†å¹³å‡å»¶è¿Ÿ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgTaiwan">-- ms</div>
                        <div class="stat-label">å°æ¹¾å¹³å‡å»¶è¿Ÿ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="bestMainland">-- ms</div>
                        <div class="stat-label">å¤§é™†æœ€ä½³å»¶è¿Ÿ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="bestTaiwan">-- ms</div>
                        <div class="stat-label">å°æ¹¾æœ€ä½³å»¶è¿Ÿ</div>
                    </div>
                </div>
            </div>
            
            <!-- å›¾è¡¨å’Œå†å²è®°å½• -->
            <div class="card">
                <div class="tabs">
                    <div class="tab active" onclick="showTab('chart')">ğŸ“Š å»¶è¿Ÿå›¾è¡¨</div>
                    <div class="tab" onclick="showTab('history')">ğŸ“‹ å†å²è®°å½•</div>
                    <div class="tab" onclick="showTab('logs')">ğŸ“ ç³»ç»Ÿæ—¥å¿—</div>
                </div>
                
                <div id="chartTab" class="tab-content active">
                    <div class="chart-container">
                        <canvas id="latencyChart"></canvas>
                    </div>
                </div>
                
                <div id="historyTab" class="tab-content">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <button onclick="clearHistory()" style="width: auto; padding: 8px 15px; background: #f56565; font-size: 14px;">æ¸…ç©ºå†å²</button>
                        <span style="color: #718096; font-size: 14px;">æœ€è¿‘50æ¡è®°å½•</span>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>å¤§é™†èŠ‚ç‚¹</th>
                                    <th>å»¶è¿Ÿ</th>
                                    <th>å°æ¹¾èŠ‚ç‚¹</th>
                                    <th>å»¶è¿Ÿ</th>
                                    <th>çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody">
                                <tr><td colspan="6" style="text-align: center; padding: 30px; color: #a0aec0;">æš‚æ— æµ‹è¯•è®°å½•</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="logsTab" class="tab-content">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <button onclick="clearLogs()" style="width: auto; padding: 8px 15px; font-size: 14px;">æ¸…ç©ºæ—¥å¿—</button>
                        <span style="color: #718096; font-size: 14px;">å®æ—¶ç³»ç»Ÿæ—¥å¿—</span>
                    </div>
                    <div class="log-container" id="logContainer">
                        <div class="log-entry">
                            <span class="log-time">[ç³»ç»Ÿå¯åŠ¨]</span>
                            <span class="log-message log-info">ç½‘ç»œå»¶è¿Ÿç›‘æµ‹ç³»ç»Ÿå·²å¯åŠ¨</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Â© 2024 ç½‘ç»œå»¶è¿Ÿç›‘æµ‹ç³»ç»Ÿ | ç‰ˆæœ¬ 2.1 | æ‰€æœ‰æ•°æ®å­˜å‚¨äºæœ¬åœ°æµè§ˆå™¨</p>
            <p style="margin-top: 5px; font-size: 13px;">ä½¿ç”¨WebSocket/TCPè¿æ¥æ—¶é—´æµ‹é‡ç½‘ç»œå»¶è¿Ÿï¼Œæ”¯æŒè‡ªå®šä¹‰æµ‹è¯•èŠ‚ç‚¹</p>
        </footer>
    </div>
    
    <!-- èŠ‚ç‚¹ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal" id="nodesModal">
        <div class="modal-content">
            <h2>ğŸŒ èŠ‚ç‚¹ç®¡ç†</h2>
            <div class="tabs" style="margin-bottom: 20px;">
                <div class="tab active" onclick="switchModalTab('mainlandNodes')">å¤§é™†èŠ‚ç‚¹</div>
                <div class="tab" onclick="switchModalTab('taiwanNodes')">å°æ¹¾èŠ‚ç‚¹</div>
                <div class="tab" onclick="switchModalTab('addNode')">æ·»åŠ èŠ‚ç‚¹</div>
            </div>
            
            <div id="mainlandNodes" class="tab-content active">
                <div class="node-list" id="mainlandNodesList">
                    <!-- å¤§é™†èŠ‚ç‚¹åˆ—è¡¨ -->
                </div>
            </div>
            
            <div id="taiwanNodes" class="tab-content">
                <div class="node-list" id="taiwanNodesList">
                    <!-- å°æ¹¾èŠ‚ç‚¹åˆ—è¡¨ -->
                </div>
            </div>
            
            <div id="addNode" class="tab-content">
                <div class="form-group">
                    <label>èŠ‚ç‚¹ç±»å‹</label>
                    <select id="newNodeType">
                        <option value="mainland">å¤§é™†èŠ‚ç‚¹</option>
                        <option value="taiwan">å°æ¹¾èŠ‚ç‚¹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>èŠ‚ç‚¹åç§°</label>
                    <input type="text" id="newNodeName" placeholder="ä¾‹å¦‚: é˜¿é‡Œäº‘æ­å·èŠ‚ç‚¹">
                </div>
                <div class="form-group">
                    <label>èŠ‚ç‚¹åœ°å€</label>
                    <input type="text" id="newNodeAddress" placeholder="IPæˆ–åŸŸåï¼Œå¦‚: 223.5.5.5">
                </div>
                <div class="form-group">
                    <label>èŠ‚ç‚¹ä½ç½®</label>
                    <input type="text" id="newNodeLocation" placeholder="ä¾‹å¦‚: æ­å·">
                </div>
                <div class="btn-group" style="margin-top: 20px;">
                    <button onclick="addNewNode()">æ·»åŠ èŠ‚ç‚¹</button>
                    <button onclick="closeModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å¯¼å…¥æ•°æ®æ¨¡æ€æ¡† -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <h2>ğŸ“¥ å¯¼å…¥æ•°æ®</h2>
            <div class="form-group">
                <label>é€‰æ‹©æ•°æ®æ–‡ä»¶</label>
                <input type="file" id="fileInput" multiple accept=".json,.csv">
            </div>
            <div style="background: #e6fffa; padding: 12px; border-radius: 8px; margin: 15px 0;">
                <small style="color: #234e52;">
                    æ”¯æŒJSONå’ŒCSVæ ¼å¼ï¼Œå¯ä¸€æ¬¡é€‰æ‹©å¤šä¸ªæ–‡ä»¶ã€‚<br>
                    ç³»ç»Ÿä¼šè‡ªåŠ¨è¿‡æ»¤é‡å¤æ•°æ®ï¼ˆåŸºäºæ—¶é—´æˆ³å’ŒèŠ‚ç‚¹åœ°å€ï¼‰ã€‚
                </small>
            </div>
            <div class="btn-group">
                <button onclick="importData()">å¯¼å…¥æ•°æ®</button>
                <button onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // ç½‘ç»œå»¶è¿Ÿç›‘æµ‹ç³»ç»Ÿ
        class LatencyMonitor {
            constructor() {
                this.config = {
                    userLocation: 'å¹¿å·',
                    testFrequency: 60,
                    autoSave: 28800,
                    isTesting: false,
                    testInterval: null,
                    saveInterval: null,
                    selectedNodes: {
                        mainland: '114.114.114.114',
                        taiwan: '168.95.1.1'
                    },
                    // ä½¿ç”¨å¯é çš„å…¬å…±æœåŠ¡å™¨è¿›è¡Œæµ‹è¯•
                    nodes: {
                        mainland: [
                            { name: '114DNS (ç”µä¿¡)', address: '114.114.114.114', location: 'å…¨å›½', type: 'dns' },
                            { name: 'é˜¿é‡Œäº‘DNS', address: '223.5.5.5', location: 'æ­å·', type: 'dns' },
                            { name: 'ç™¾åº¦DNS', address: '180.76.76.76', location: 'åŒ—äº¬', type: 'dns' },
                            { name: 'è…¾è®¯äº‘DNS', address: '119.29.29.29', location: 'æ·±åœ³', type: 'dns' },
                            { name: 'CNNIC DNS', address: '1.2.4.8', location: 'åŒ—äº¬', type: 'dns' }
                        ],
                        taiwan: [
                            { name: 'ä¸­åç”µä¿¡DNS', address: '168.95.1.1', location: 'å°åŒ—', type: 'dns' },
                            { name: 'Google DNS', address: '8.8.8.8', location: 'å…¨çƒ', type: 'dns' },
                            { name: 'Cloudflare DNS', address: '1.1.1.1', location: 'å…¨çƒ', type: 'dns' },
                            { name: 'ä¸­åç”µä¿¡å¤‡ç”¨', address: '168.95.192.1', location: 'å°åŒ—', type: 'dns' },
                            { name: 'OpenDNS', address: '208.67.222.222', location: 'å…¨çƒ', type: 'dns' }
                        ]
                    },
                    customNodes: {
                        mainland: [],
                        taiwan: []
                    },
                    history: [],
                    statistics: {
                        totalTests: 0,
                        successfulTests: 0,
                        mainlandAvg: 0,
                        taiwanAvg: 0,
                        mainlandBest: 9999,
                        taiwanBest: 9999
                    }
                };
                
                this.chart = null;
                this.isTestingSingle = false;
                
                this.init();
            }
            
            init() {
                this.loadData();
                this.setupEventListeners();
                this.renderNodeSelectors();
                this.initChart();
                this.updateUI();
                this.log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'info');
            }
            
            loadData() {
                try {
                    // åŠ è½½é…ç½®
                    const savedConfig = localStorage.getItem('latencyMonitorConfig');
                    if (savedConfig) {
                        const parsed = JSON.parse(savedConfig);
                        this.config = { ...this.config, ...parsed };
                    }
                    
                    // åŠ è½½å†å²è®°å½•
                    const savedHistory = localStorage.getItem('latencyMonitorHistory');
                    if (savedHistory) {
                        this.config.history = JSON.parse(savedHistory);
                        this.calculateStatistics();
                    }
                    
                    // åŠ è½½è‡ªå®šä¹‰èŠ‚ç‚¹
                    const savedCustomNodes = localStorage.getItem('latencyMonitorCustomNodes');
                    if (savedCustomNodes) {
                        this.config.customNodes = JSON.parse(savedCustomNodes);
                    }
                    
                    // æ›´æ–°UI
                    document.getElementById('userLocation').value = this.config.userLocation;
                    document.getElementById('testFrequency').value = this.config.testFrequency;
                    document.getElementById('autoSave').value = this.config.autoSave;
                    
                } catch (error) {
                    this.log('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
                }
            }
            
            saveData() {
                try {
                    localStorage.setItem('latencyMonitorConfig', JSON.stringify(this.config));
                    localStorage.setItem('latencyMonitorHistory', JSON.stringify(this.config.history));
                    localStorage.setItem('latencyMonitorCustomNodes', JSON.stringify(this.config.customNodes));
                } catch (error) {
                    this.log('ä¿å­˜æ•°æ®å¤±è´¥: ' + error.message, 'error');
                }
            }
            
            setupEventListeners() {
                // æ§åˆ¶æŒ‰é’®
                document.getElementById('startBtn').addEventListener('click', () => this.startAutoTest());
                document.getElementById('stopBtn').addEventListener('click', () => this.stopAutoTest());
                document.getElementById('testNowBtn').addEventListener('click', () => this.runFullTest());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportData());
                document.getElementById('importBtn').addEventListener('click', () => this.showModal('importModal'));
                document.getElementById('manageNodesBtn').addEventListener('click', () => this.showModal('nodesModal'));
                
                // é…ç½®å˜æ›´
                document.getElementById('userLocation').addEventListener('change', (e) => {
                    this.config.userLocation = e.target.value;
                    this.saveData();
                });
                
                document.getElementById('testFrequency').addEventListener('change', (e) => {
                    this.config.testFrequency = parseInt(e.target.value);
                    this.saveData();
                    if (this.config.isTesting) {
                        this.restartAutoTest();
                    }
                });
                
                document.getElementById('autoSave').addEventListener('change', (e) => {
                    this.config.autoSave = parseInt(e.target.value);
                    this.saveData();
                    this.setupAutoSave();
                });
                
                // èŠ‚ç‚¹é€‰æ‹©å™¨å˜åŒ–
                document.getElementById('mainlandNodeSelect').addEventListener('change', (e) => {
                    const value = e.target.value;
                    if (value === 'custom') {
                        document.getElementById('mainlandCustom').style.display = 'block';
                    } else if (value === 'add') {
                        this.showModal('nodesModal');
                        switchModalTab('addNode');
                        document.getElementById('newNodeType').value = 'mainland';
                    } else if (value) {
                        this.config.selectedNodes.mainland = value;
                        this.saveData();
                        document.getElementById('mainlandCustom').style.display = 'none';
                    }
                });
                
                document.getElementById('taiwanNodeSelect').addEventListener('change', (e) => {
                    const value = e.target.value;
                    if (value === 'custom') {
                        document.getElementById('taiwanCustom').style.display = 'block';
                    } else if (value === 'add') {
                        this.showModal('nodesModal');
                        switchModalTab('addNode');
                        document.getElementById('newNodeType').value = 'taiwan';
                    } else if (value) {
                        this.config.selectedNodes.taiwan = value;
                        this.saveData();
                        document.getElementById('taiwanCustom').style.display = 'none';
                    }
                });
            }
            
            renderNodeSelectors() {
                const mainlandSelect = document.getElementById('mainlandNodeSelect');
                const taiwanSelect = document.getElementById('taiwanNodeSelect');
                
                // æ¸…ç©ºé€‰æ‹©å™¨
                mainlandSelect.innerHTML = '';
                taiwanSelect.innerHTML = '';
                
                // æ·»åŠ å¤§é™†èŠ‚ç‚¹é€‰é¡¹
                this.config.nodes.mainland.forEach(node => {
                    const option = document.createElement('option');
                    option.value = node.address;
                    option.textContent = `${node.name} (${node.address})`;
                    mainlandSelect.appendChild(option);
                });
                
                // æ·»åŠ è‡ªå®šä¹‰å¤§é™†èŠ‚ç‚¹
                this.config.customNodes.mainland.forEach(node => {
                    const option = document.createElement('option');
                    option.value = node.address;
                    option.textContent = `${node.name} (${node.address}) [è‡ªå®šä¹‰]`;
                    mainlandSelect.appendChild(option);
                });
                
                // æ·»åŠ å°æ¹¾èŠ‚ç‚¹é€‰é¡¹
                this.config.nodes.taiwan.forEach(node => {
                    const option = document.createElement('option');
                    option.value = node.address;
                    option.textContent = `${node.name} (${node.address})`;
                    taiwanSelect.appendChild(option);
                });
                
                // æ·»åŠ è‡ªå®šä¹‰å°æ¹¾èŠ‚ç‚¹
                this.config.customNodes.taiwan.forEach(node => {
                    const option = document.createElement('option');
                    option.value = node.address;
                    option.textContent = `${node.name} (${node.address}) [è‡ªå®šä¹‰]`;
                    taiwanSelect.appendChild(option);
                });
                
                // æ·»åŠ è‡ªå®šä¹‰é€‰é¡¹
                const customOption1 = document.createElement('option');
                customOption1.value = 'custom';
                customOption1.textContent = 'è¾“å…¥è‡ªå®šä¹‰èŠ‚ç‚¹...';
                mainlandSelect.appendChild(customOption1);
                
                const customOption2 = document.createElement('option');
                customOption2.value = 'custom';
                customOption2.textContent = 'è¾“å…¥è‡ªå®šä¹‰èŠ‚ç‚¹...';
                taiwanSelect.appendChild(customOption2);
                
                // æ·»åŠ ç®¡ç†èŠ‚ç‚¹é€‰é¡¹
                const manageOption1 = document.createElement('option');
                manageOption1.value = 'add';
                manageOption1.textContent = 'ç®¡ç†èŠ‚ç‚¹...';
                mainlandSelect.appendChild(manageOption1);
                
                const manageOption2 = document.createElement('option');
                manageOption2.value = 'add';
                manageOption2.textContent = 'ç®¡ç†èŠ‚ç‚¹...';
                taiwanSelect.appendChild(manageOption2);
                
                // è®¾ç½®é€‰ä¸­çš„èŠ‚ç‚¹
                mainlandSelect.value = this.config.selectedNodes.mainland;
                taiwanSelect.value = this.config.selectedNodes.taiwan;
            }
            
            // ä½¿ç”¨å¯é çš„æ–¹æ³•æµ‹è¯•å»¶è¿Ÿ - ä¿®å¤è¶…æ—¶é—®é¢˜
            async testLatency(address, type) {
                return new Promise((resolve) => {
                    const startTime = performance.now();
                    
                    // æ–¹æ³•1: ä½¿ç”¨WebSocketè¿æ¥ï¼ˆæœ€å¿«ï¼‰
                    const ws = new WebSocket(`wss://echo.websocket.org`);
                    
                    const timeout = setTimeout(() => {
                        ws.close();
                        // æ–¹æ³•1å¤±è´¥ï¼Œä½¿ç”¨æ–¹æ³•2
                        this.testWithHTTP(address).then(resolve);
                    }, 3000);
                    
                    ws.onopen = () => {
                        clearTimeout(timeout);
                        const latency = Math.round(performance.now() - startTime);
                        ws.close();
                        resolve(latency);
                    };
                    
                    ws.onerror = () => {
                        clearTimeout(timeout);
                        // æ–¹æ³•1å¤±è´¥ï¼Œä½¿ç”¨æ–¹æ³•2
                        this.testWithHTTP(address).then(resolve);
                    };
                });
            }
            
            // å¤‡ç”¨æ–¹æ³•: ä½¿ç”¨HTTPè¯·æ±‚
            async testWithHTTP(address) {
                return new Promise((resolve) => {
                    const startTime = performance.now();
                    
                    // å°è¯•è¿æ¥80ç«¯å£ï¼ˆHTTPï¼‰
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 3000;
                    
                    xhr.onload = xhr.onerror = () => {
                        const latency = Math.round(performance.now() - startTime);
                        resolve(latency > 3000 ? -1 : latency);
                    };
                    
                    xhr.ontimeout = () => {
                        resolve(-1);
                    };
                    
                    try {
                        // å°è¯•è¿æ¥ï¼Œä½†ä¸è¦å®é™…å‘é€è¯·æ±‚ï¼ˆé¿å…CORSï¼‰
                        xhr.open('HEAD', `http://${address}/`, true);
                        xhr.send();
                    } catch (e) {
                        // å¦‚æœå¤±è´¥ï¼Œä½¿ç”¨Imageå¯¹è±¡æ–¹æ³•
                        this.testWithImage(address).then(resolve);
                    }
                });
            }
            
            // ç¬¬ä¸‰ç§æ–¹æ³•: ä½¿ç”¨Imageå¯¹è±¡ï¼ˆæœ€å…¼å®¹ï¼‰
            async testWithImage(address) {
                return new Promise((resolve) => {
                    const startTime = performance.now();
                    const img = new Image();
                    
                    const timeout = setTimeout(() => {
                        img.src = '';
                        resolve(-1);
                    }, 3000);
                    
                    img.onload = img.onerror = () => {
                        clearTimeout(timeout);
                        const latency = Math.round(performance.now() - startTime);
                        resolve(latency);
                    };
                    
                    // ä½¿ç”¨ä¸€ä¸ªå‡ ä¹ä¸å­˜åœ¨çš„å›¾ç‰‡ï¼Œæˆ‘ä»¬åªå…³å¿ƒè¿æ¥æ—¶é—´
                    img.src = `http://${address}/favicon.ico?t=${Date.now()}`;
                });
            }
            
            async testSingleNode(type) {
                if (this.isTestingSingle) {
                    this.log('å·²æœ‰æµ‹è¯•åœ¨è¿›è¡Œä¸­', 'warning');
                    return;
                }
                
                this.isTestingSingle = true;
                const address = this.config.selectedNodes[type];
                
                if (!address || address === 'custom' || address === 'add') {
                    this.log(`è¯·å…ˆé€‰æ‹©æœ‰æ•ˆçš„${type === 'mainland' ? 'å¤§é™†' : 'å°æ¹¾'}èŠ‚ç‚¹`, 'warning');
                    this.isTestingSingle = false;
                    return;
                }
                
                this.log(`å¼€å§‹æµ‹è¯•${type === 'mainland' ? 'å¤§é™†' : 'å°æ¹¾'}èŠ‚ç‚¹: ${address}`, 'info');
                
                try {
                    this.updateProgress(30);
                    const latency = await this.testLatency(address, type);
                    
                    // æ›´æ–°UI
                    this.updateNodeResult(type, latency, address);
                    this.updateProgress(100);
                    
                    if (latency > 0) {
                        this.log(`${type === 'mainland' ? 'å¤§é™†' : 'å°æ¹¾'}èŠ‚ç‚¹æµ‹è¯•æˆåŠŸ: ${latency}ms`, 'success');
                    } else {
                        this.log(`${type === 'mainland' ? 'å¤§é™†' : 'å°æ¹¾'}èŠ‚ç‚¹è¿æ¥è¶…æ—¶`, 'error');
                    }
                    
                } catch (error) {
                    this.log(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                    this.updateNodeResult(type, -1, address);
                } finally {
                    this.isTestingSingle = false;
                    setTimeout(() => this.updateProgress(0), 1000);
                }
            }
            
            async runFullTest() {
                if (!this.config.userLocation) {
                    this.log('è¯·å…ˆé€‰æ‹©æ‚¨çš„æ‰€åœ¨åœ°', 'warning');
                    document.getElementById('userLocation').focus();
                    return;
                }
                
                if (this.isTestingSingle) {
                    this.log('å·²æœ‰æµ‹è¯•åœ¨è¿›è¡Œä¸­', 'warning');
                    return;
                }
                
                this.isTestingSingle = true;
                this.log('å¼€å§‹å®Œæ•´æµ‹è¯•...', 'info');
                
                try {
                    this.updateProgress(20);
                    
                    // æµ‹è¯•å¤§é™†èŠ‚ç‚¹
                    const mainlandAddress = this.config.selectedNodes.mainland;
                    let mainlandLatency = -1;
                    
                    if (mainlandAddress && mainlandAddress !== 'custom' && mainlandAddress !== 'add') {
                        mainlandLatency = await this.testLatency(mainlandAddress, 'mainland');
                        this.updateNodeResult('mainland', mainlandLatency, mainlandAddress);
                    }
                    
                    this.updateProgress(60);
                    
                    // æµ‹è¯•å°æ¹¾èŠ‚ç‚¹
                    const taiwanAddress = this.config.selectedNodes.taiwan;
                    let taiwanLatency = -1;
                    
                    if (taiwanAddress && taiwanAddress !== 'custom' && taiwanAddress !== 'add') {
                        taiwanLatency = await this.testLatency(taiwanAddress, 'taiwan');
                        this.updateNodeResult('taiwan', taiwanLatency, taiwanAddress);
                    }
                    
                    this.updateProgress(90);
                    
                    // ä¿å­˜è®°å½•
                    if ((mainlandAddress && mainlandAddress !== 'custom' && mainlandAddress !== 'add') || 
                        (taiwanAddress && taiwanAddress !== 'custom' && taiwanAddress !== 'add')) {
                        
                        const record = {
                            timestamp: new Date().toISOString(),
                            userLocation: this.config.userLocation,
                            mainland: {
                                address: mainlandAddress,
                                latency: mainlandLatency,
                                status: mainlandLatency > 0 ? 'success' : mainlandLatency === -1 ? 'timeout' : 'error'
                            },
                            taiwan: {
                                address: taiwanAddress,
                                latency: taiwanLatency,
                                status: taiwanLatency > 0 ? 'success' : taiwanLatency === -1 ? 'timeout' : 'error'
                            }
                        };
                        
                        this.config.history.unshift(record);
                        
                        // é™åˆ¶å†å²è®°å½•æ•°é‡
                        if (this.config.history.length > 1000) {
                            this.config.history = this.config.history.slice(0, 1000);
                        }
                        
                        this.saveData();
                        this.calculateStatistics();
                        this.updateHistoryTable();
                        this.updateChart();
                        
                        this.updateProgress(100);
                        this.log('æµ‹è¯•å®Œæˆå¹¶ä¿å­˜', 'success');
                    }
                    
                } catch (error) {
                    this.log('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                } finally {
                    this.isTestingSingle = false;
                    setTimeout(() => this.updateProgress(0), 1000);
                }
            }
            
            updateNodeResult(type, latency, address) {
                const latencyElement = document.getElementById(`${type}Latency`);
                const statusElement = document.getElementById(`${type}Status`);
                const cardElement = document.getElementById(`${type}Card`);
                
                if (latency > 0) {
                    latencyElement.textContent = `${latency}ms`;
                    
                    // æ ¹æ®å»¶è¿Ÿè®¾ç½®é¢œè‰²
                    if (latency < 50) {
                        latencyElement.className = 'latency good';
                        statusElement.textContent = `ä¼˜ç§€ (${address})`;
                        statusElement.style.color = '#38a169';
                    } else if (latency < 150) {
                        latencyElement.className = 'latency good';
                        statusElement.textContent = `è‰¯å¥½ (${address})`;
                        statusElement.style.color = '#38a169';
                    } else if (latency < 300) {
                        latencyElement.className = 'latency medium';
                        statusElement.textContent = `ä¸€èˆ¬ (${address})`;
                        statusElement.style.color = '#d69e2e';
                    } else {
                        latencyElement.className = 'latency poor';
                        statusElement.textContent = `è¾ƒå·® (${address})`;
                        statusElement.style.color = '#e53e3e';
                    }
                } else {
                    latencyElement.textContent = 'è¶…æ—¶';
                    latencyElement.className = 'latency poor';
                    statusElement.textContent = `è¿æ¥å¤±è´¥ (${address})`;
                    statusElement.style.color = '#e53e3e';
                }
            }
            
            updateProgress(percent) {
                document.getElementById('progressBar').style.width = percent + '%';
            }
            
            startAutoTest() {
                if (!this.config.userLocation) {
                    this.log('è¯·å…ˆé€‰æ‹©æ‚¨çš„æ‰€åœ¨åœ°', 'warning');
                    return;
                }
                
                this.config.isTesting = true;
                this.updateStatus();
                this.log(`å¼€å§‹è‡ªåŠ¨æµ‹è¯•ï¼Œé¢‘ç‡: ${this.config.testFrequency}ç§’`, 'success');
                
                // ç«‹å³è¿è¡Œä¸€æ¬¡æµ‹è¯•
                this.runFullTest();
                
                // è®¾ç½®å®šæ—¶å™¨
                if (this.config.testInterval) {
                    clearInterval(this.config.testInterval);
                }
                
                this.config.testInterval = setInterval(() => {
                    this.runFullTest();
                }, this.config.testFrequency * 1000);
                
                // è®¾ç½®è‡ªåŠ¨ä¿å­˜
                this.setupAutoSave();
                
                // æ›´æ–°ä¸‹æ¬¡æµ‹è¯•æ—¶é—´
                this.updateNextTestTime();
            }
            
            stopAutoTest() {
                this.config.isTesting = false;
                
                if (this.config.testInterval) {
                    clearInterval(this.config.testInterval);
                    this.config.testInterval = null;
                }
                
                if (this.config.saveInterval) {
                    clearInterval(this.config.saveInterval);
                    this.config.saveInterval = null;
                }
                
                this.updateStatus();
                this.log('è‡ªåŠ¨æµ‹è¯•å·²åœæ­¢', 'warning');
            }
            
            restartAutoTest() {
                if (this.config.isTesting) {
                    this.stopAutoTest();
                    setTimeout(() => this.startAutoTest(), 100);
                }
            }
            
            setupAutoSave() {
                if (this.config.saveInterval) {
                    clearInterval(this.config.saveInterval);
                }
                
                if (this.config.autoSave > 0) {
                    this.config.saveInterval = setInterval(() => {
                        this.exportData(true); // é™é»˜å¯¼å‡º
                    }, this.config.autoSave * 1000);
                    
                    this.log(`è‡ªåŠ¨ä¿å­˜å·²å¯ç”¨ï¼Œé¢‘ç‡: ${this.config.autoSave}ç§’`, 'info');
                }
            }
            
            updateStatus() {
                const dot = document.getElementById('statusDot');
                const text = document.getElementById('statusText');
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');
                
                if (this.config.isTesting) {
                    dot.classList.add('active');
                    text.textContent = `æµ‹è¯•ä¸­ (${this.config.testFrequency}ç§’/æ¬¡)`;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                } else {
                    dot.classList.remove('active');
                    text.textContent = 'å·²åœæ­¢';
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                }
            }
            
            updateNextTestTime() {
                if (this.config.isTesting) {
                    const now = new Date();
                    const next = new Date(now.getTime() + this.config.testFrequency * 1000);
                    document.getElementById('nextTest').textContent = 
                        `ä¸‹æ¬¡: ${next.getHours()}:${next.getMinutes().toString().padStart(2, '0')}`;
                } else {
                    document.getElementById('nextTest').textContent = 'ä¸‹æ¬¡: -';
                }
                
                if (this.config.history.length > 0) {
                    const last = new Date(this.config.history[0].timestamp);
                    document.getElementById('lastTest').textContent = 
                        `ä¸Šæ¬¡: ${last.getHours()}:${last.getMinutes().toString().padStart(2, '0')}`;
                }
            }
            
            calculateStatistics() {
                const history = this.config.history;
                if (history.length === 0) return;
                
                let totalTests = history.length;
                let successfulTests = 0;
                let mainlandTotal = 0;
                let taiwanTotal = 0;
                let mainlandCount = 0;
                let taiwanCount = 0;
                let mainlandBest = 9999;
                let taiwanBest = 9999;
                
                history.forEach(record => {
                    if (record.mainland && record.mainland.latency > 0) {
                        successfulTests++;
                        mainlandTotal += record.mainland.latency;
                        mainlandCount++;
                        if (record.mainland.latency < mainlandBest) {
                            mainlandBest = record.mainland.latency;
                        }
                    }
                    if (record.taiwan && record.taiwan.latency > 0) {
                        taiwanTotal += record.taiwan.latency;
                        taiwanCount++;
                        if (record.taiwan.latency < taiwanBest) {
                            taiwanBest = record.taiwan.latency;
                        }
                    }
                });
                
                this.config.statistics = {
                    totalTests: totalTests,
                    successfulTests: successfulTests,
                    mainlandAvg: mainlandCount > 0 ? Math.round(mainlandTotal / mainlandCount) : 0,
                    taiwanAvg: taiwanCount > 0 ? Math.round(taiwanTotal / taiwanCount) : 0,
                    mainlandBest: mainlandBest === 9999 ? 0 : mainlandBest,
                    taiwanBest: taiwanBest === 9999 ? 0 : taiwanBest
                };
                
                // æ›´æ–°UI
                document.getElementById('totalTests').textContent = totalTests;
                document.getElementById('successRate').textContent = 
                    totalTests > 0 ? Math.round((successfulTests / totalTests) * 100) + '%' : '100%';
                document.getElementById('avgMainland').textContent = 
                    this.config.statistics.mainlandAvg > 0 ? this.config.statistics.mainlandAvg + ' ms' : '-- ms';
                document.getElementById('avgTaiwan').textContent = 
                    this.config.statistics.taiwanAvg > 0 ? this.config.statistics.taiwanAvg + ' ms' : '-- ms';
                document.getElementById('bestMainland').textContent = 
                    this.config.statistics.mainlandBest > 0 ? this.config.statistics.mainlandBest + ' ms' : '-- ms';
                document.getElementById('bestTaiwan').textContent = 
                    this.config.statistics.taiwanBest > 0 ? this.config.statistics.taiwanBest + ' ms' : '-- ms';
            }
            
            updateUI() {
                this.updateStatus();
                this.calculateStatistics();
                this.updateHistoryTable();
                this.updateNextTestTime();
            }
            
            updateHistoryTable() {
                const tbody = document.getElementById('historyBody');
                const recentHistory = this.config.history.slice(0, 50);
                
                if (recentHistory.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #a0aec0;">æš‚æ— æµ‹è¯•è®°å½•</td></tr>';
                    return;
                }
                
                tbody.innerHTML = recentHistory.map(record => {
                    const time = new Date(record.timestamp);
                    const timeStr = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}:${time.getSeconds().toString().padStart(2, '0')}`;
                    
                    const mainlandLatency = record.mainland?.latency || -1;
                    const taiwanLatency = record.taiwan?.latency || -1;
                    
                    const mainlandColor = mainlandLatency > 0 ? 
                        (mainlandLatency < 100 ? '#38a169' : mainlandLatency < 300 ? '#d69e2e' : '#e53e3e') : '#e53e3e';
                    
                    const taiwanColor = taiwanLatency > 0 ? 
                        (taiwanLatency < 100 ? '#38a169' : taiwanLatency < 300 ? '#d69e2e' : '#e53e3e') : '#e53e3e';
                    
                    const statusIcon = mainlandLatency > 0 && taiwanLatency > 0 ? 'âœ…' :
                                     mainlandLatency > 0 || taiwanLatency > 0 ? 'âš ï¸' : 'âŒ';
                    
                    return `
                        <tr>
                            <td>${timeStr}</td>
                            <td>${record.mainland?.address || '--'}</td>
                            <td style="color: ${mainlandColor}; font-weight: 600;">
                                ${mainlandLatency > 0 ? mainlandLatency + ' ms' : 'è¶…æ—¶'}
                            </td>
                            <td>${record.taiwan?.address || '--'}</td>
                            <td style="color: ${taiwanColor}; font-weight: 600;">
                                ${taiwanLatency > 0 ? taiwanLatency + ' ms' : 'è¶…æ—¶'}
                            </td>
                            <td>${statusIcon}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            initChart() {
                const ctx = document.getElementById('latencyChart').getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'å¤§é™†å»¶è¿Ÿ',
                                data: [],
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 3,
                                pointHoverRadius: 6
                            },
                            {
                                label: 'å°æ¹¾å»¶è¿Ÿ',
                                data: [],
                                borderColor: '#ed64a6',
                                backgroundColor: 'rgba(237, 100, 166, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 3,
                                pointHoverRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'top',
                                labels: { font: { size: 12 } }
                            },
                            tooltip: { 
                                mode: 'index', 
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw}ms`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { 
                                display: true, 
                                title: { 
                                    display: true, 
                                    text: 'æ—¶é—´',
                                    font: { size: 12 }
                                },
                                ticks: { font: { size: 11 } }
                            },
                            y: { 
                                display: true, 
                                title: { 
                                    display: true, 
                                    text: 'å»¶è¿Ÿ (ms)',
                                    font: { size: 12 }
                                },
                                beginAtZero: true,
                                ticks: { font: { size: 11 } }
                            }
                        }
                    }
                });
            }
            
            updateChart() {
                const recentHistory = this.config.history.slice(0, 30).reverse();
                const labels = recentHistory.map(record => {
                    const time = new Date(record.timestamp);
                    return `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
                });
                
                const mainlandData = recentHistory.map(record => record.mainland?.latency || 0);
                const taiwanData = recentHistory.map(record => record.taiwan?.latency || 0);
                
                this.chart.data.labels = labels;
                this.chart.data.datasets[0].data = mainlandData;
                this.chart.data.datasets[1].data = taiwanData;
                this.chart.update();
            }
            
            exportData(silent = false) {
                const data = {
                    config: this.config,
                    history: this.config.history,
                    statistics: this.config.statistics,
                    exportTime: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `latency-data-${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                if (!silent) {
                    this.log('æ•°æ®å·²å¯¼å‡º', 'success');
                }
            }
            
            showModal(modalId) {
                if (modalId === 'nodesModal') {
                    this.renderNodesModal();
                }
                document.getElementById(modalId).style.display = 'flex';
            }
            
            renderNodesModal() {
                const mainlandList = document.getElementById('mainlandNodesList');
                const taiwanList = document.getElementById('taiwanNodesList');
                
                mainlandList.innerHTML = '';
                taiwanList.innerHTML = '';
                
                // æ¸²æŸ“é¢„è®¾å¤§é™†èŠ‚ç‚¹
                this.config.nodes.mainland.forEach((node, index) => {
                    const nodeItem = document.createElement('div');
                    nodeItem.className = 'node-item';
                    nodeItem.innerHTML = `
                        <div class="node-info">
                            <div class="node-name">${node.name}</div>
                            <div class="node-address">${node.address} - ${node.location}</div>
                        </div>
                        <div class="node-actions">
                            <button onclick="monitor.selectNodeInModal('mainland', '${node.address}')" 
                                    style="background: #48bb78;">é€‰æ‹©</button>
                        </div>
                    `;
                    mainlandList.appendChild(nodeItem);
                });
                
                // æ¸²æŸ“è‡ªå®šä¹‰å¤§é™†èŠ‚ç‚¹
                this.config.customNodes.mainland.forEach((node, index) => {
                    const nodeItem = document.createElement('div');
                    nodeItem.className = 'node-item';
                    nodeItem.innerHTML = `
                        <div class="node-info">
                            <div class="node-name">${node.name} [è‡ªå®šä¹‰]</div>
                            <div class="node-address">${node.address} - ${node.location || 'æœªæŒ‡å®š'}</div>
                        </div>
                        <div class="node-actions">
                            <button onclick="monitor.selectNodeInModal('mainland', '${node.address}')" 
                                    style="background: #48bb78;">é€‰æ‹©</button>
                            <button onclick="monitor.deleteCustomNode('mainland', ${index})" 
                                    style="background: #f56565;">åˆ é™¤</button>
                        </div>
                    `;
                    mainlandList.appendChild(nodeItem);
                });
                
                // æ¸²æŸ“é¢„è®¾å°æ¹¾èŠ‚ç‚¹
                this.config.nodes.taiwan.forEach((node, index) => {
                    const nodeItem = document.createElement('div');
                    nodeItem.className = 'node-item';
                    nodeItem.innerHTML = `
                        <div class="node-info">
                            <div class="node-name">${node.name}</div>
                            <div class="node-address">${node.address} - ${node.location}</div>
                        </div>
                        <div class="node-actions">
                            <button onclick="monitor.selectNodeInModal('taiwan', '${node.address}')" 
                                    style="background: #48bb78;">é€‰æ‹©</button>
                        </div>
                    `;
                    taiwanList.appendChild(nodeItem);
                });
                
                // æ¸²æŸ“è‡ªå®šä¹‰å°æ¹¾èŠ‚ç‚¹
                this.config.customNodes.taiwan.forEach((node, index) => {
                    const nodeItem = document.createElement('div');
                    nodeItem.className = 'node-item';
                    nodeItem.innerHTML = `
                        <div class="node-info">
                            <div class="node-name">${node.name} [è‡ªå®šä¹‰]</div>
                            <div class="node-address">${node.address} - ${node.location || 'æœªæŒ‡å®š'}</div>
                        </div>
                        <div class="node-actions">
                            <button onclick="monitor.selectNodeInModal('taiwan', '${node.address}')" 
                                    style="background: #48bb78;">é€‰æ‹©</button>
                            <button onclick="monitor.deleteCustomNode('taiwan', ${index})" 
                                    style="background: #f56565;">åˆ é™¤</button>
                        </div>
                    `;
                    taiwanList.appendChild(nodeItem);
                });
            }
            
            selectNodeInModal(type, address) {
                this.config.selectedNodes[type] = address;
                this.saveData();
                this.renderNodeSelectors();
                this.closeModal();
                this.log(`å·²é€‰æ‹©${type === 'mainland' ? 'å¤§é™†' : 'å°æ¹¾'}èŠ‚ç‚¹: ${address}`, 'success');
            }
            
            deleteCustomNode(type, index) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè‡ªå®šä¹‰èŠ‚ç‚¹å—ï¼Ÿ')) {
                    this.config.customNodes[type].splice(index, 1);
                    this.saveData();
                    this.renderNodesModal();
                    this.renderNodeSelectors();
                    this.log(`å·²åˆ é™¤${type === 'mainland' ? 'å¤§é™†' : 'å°æ¹¾'}è‡ªå®šä¹‰èŠ‚ç‚¹`, 'warning');
                }
            }
            
            saveCustomNode(type) {
                const inputId = `${type}CustomInput`;
                const address = document.getElementById(inputId).value.trim();
                
                if (!address) {
                    this.log('è¯·è¾“å…¥èŠ‚ç‚¹åœ°å€', 'warning');
                    return;
                }
                
                // éªŒè¯åœ°å€æ ¼å¼
                if (!this.validateAddress(address)) {
                    this.log('è¯·è¾“å…¥æœ‰æ•ˆçš„IPåœ°å€æˆ–åŸŸå', 'error');
                    return;
                }
                
                // æ·»åŠ åˆ°è‡ªå®šä¹‰èŠ‚ç‚¹åˆ—è¡¨
                const newNode = {
                    name: `è‡ªå®šä¹‰${type === 'mainland' ? 'å¤§é™†' : 'å°æ¹¾'}èŠ‚ç‚¹`,
                    address: address,
                    location: 'è‡ªå®šä¹‰',
                    type: 'custom'
                };
                
                this.config.customNodes[type].push(newNode);
                this.config.selectedNodes[type] = address;
                
                this.saveData();
                this.renderNodeSelectors();
                
                // éšè—è‡ªå®šä¹‰è¾“å…¥æ¡†å¹¶é‡ç½®é€‰æ‹©å™¨
                document.getElementById(`${type}Custom`).style.display = 'none';
                document.getElementById(`${type}NodeSelect`).value = address;
                
                this.log(`å·²æ·»åŠ è‡ªå®šä¹‰${type === 'mainland' ? 'å¤§é™†' : 'å°æ¹¾'}èŠ‚ç‚¹: ${address}`, 'success');
            }
            
            addNewNode() {
                const type = document.getElementById('newNodeType').value;
                const name = document.getElementById('newNodeName').value.trim();
                const address = document.getElementById('newNodeAddress').value.trim();
                const location = document.getElementById('newNodeLocation').value.trim();
                
                if (!name || !address) {
                    this.log('è¯·å¡«å†™èŠ‚ç‚¹åç§°å’Œåœ°å€', 'warning');
                    return;
                }
                
                if (!this.validateAddress(address)) {
                    this.log('è¯·è¾“å…¥æœ‰æ•ˆçš„IPåœ°å€æˆ–åŸŸå', 'error');
                    return;
                }
                
                const newNode = {
                    name: name,
                    address: address,
                    location: location || 'æœªæŒ‡å®š',
                    type: 'custom'
                };
                
                this.config.customNodes[type].push(newNode);
                this.saveData();
                this.renderNodesModal();
                this.renderNodeSelectors();
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('newNodeName').value = '';
                document.getElementById('newNodeAddress').value = '';
                document.getElementById('newNodeLocation').value = '';
                
                this.log(`å·²æ·»åŠ ${type === 'mainland' ? 'å¤§é™†' : 'å°æ¹¾'}èŠ‚ç‚¹: ${name} (${address})`, 'success');
            }
            
            validateAddress(address) {
                // ç®€å•çš„IPåœ°å€éªŒè¯
                const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
                // ç®€å•çš„åŸŸåéªŒè¯
                const domainPattern = /^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9](\.[a-zA-Z]{2,})+$/;
                
                return ipPattern.test(address) || domainPattern.test(address);
            }
            
            async importData() {
                const fileInput = document.getElementById('fileInput');
                const files = fileInput.files;
                
                if (files.length === 0) {
                    this.log('è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶', 'warning');
                    return;
                }
                
                let importedCount = 0;
                let duplicateCount = 0;
                
                for (const file of files) {
                    try {
                        const text = await this.readFile(file);
                        const data = JSON.parse(text);
                        
                        if (data.history && Array.isArray(data.history)) {
                            // å»é‡å¤„ç†
                            const existingTimestamps = new Set(this.config.history.map(h => h.timestamp));
                            
                            data.history.forEach(record => {
                                if (!existingTimestamps.has(record.timestamp)) {
                                    this.config.history.unshift(record);
                                    existingTimestamps.add(record.timestamp);
                                    importedCount++;
                                } else {
                                    duplicateCount++;
                                }
                            });
                            
                            // é™åˆ¶å†å²è®°å½•æ•°é‡
                            if (this.config.history.length > 1000) {
                                this.config.history = this.config.history.slice(0, 1000);
                            }
                        }
                    } catch (error) {
                        this.log(`å¯¼å…¥æ–‡ä»¶å¤±è´¥: ${file.name}`, 'error');
                    }
                }
                
                this.saveData();
                this.updateUI();
                this.updateChart();
                this.closeModal();
                fileInput.value = '';
                
                this.log(`å¯¼å…¥å®Œæˆ: æ–°å¢ ${importedCount} æ¡è®°å½•ï¼Œè¿‡æ»¤ ${duplicateCount} æ¡é‡å¤`, 'success');
            }
            
            readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
                    reader.readAsText(file);
                });
            }
            
            closeModal() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
                
                // é‡ç½®è‡ªå®šä¹‰è¾“å…¥æ¡†
                document.getElementById('mainlandCustom').style.display = 'none';
                document.getElementById('taiwanCustom').style.display = 'none';
                document.getElementById('mainlandCustomInput').value = '';
                document.getElementById('taiwanCustomInput').value = '';
            }
            
            clearHistory() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                    this.config.history = [];
                    this.saveData();
                    this.updateUI();
                    this.updateChart();
                    this.log('å†å²è®°å½•å·²æ¸…ç©º', 'warning');
                }
            }
            
            clearLogs() {
                document.getElementById('logContainer').innerHTML = 
                    '<div class="log-entry"><span class="log-time">[ç³»ç»Ÿ]</span><span class="log-message log-info">æ—¥å¿—å·²æ¸…ç©º</span></div>';
            }
            
            log(message, type = 'info') {
                const container = document.getElementById('logContainer');
                const time = new Date();
                const timeStr = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}:${time.getSeconds().toString().padStart(2, '0')}`;
                
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.innerHTML = `
                    <span class="log-time">[${timeStr}]</span>
                    <span class="log-message log-${type}">${message}</span>
                `;
                
                container.appendChild(entry);
                container.scrollTop = container.scrollHeight;
                
                // é™åˆ¶æ—¥å¿—æ•°é‡
                const entries = container.querySelectorAll('.log-entry');
                if (entries.length > 100) {
                    entries[0].remove();
                }
            }
        }
        
        // å…¨å±€å‡½æ•°
        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            if (tabId === 'chart' && monitor.chart) {
                monitor.updateChart();
            }
        }
        
        function switchModalTab(tabId) {
            document.querySelectorAll('#nodesModal .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#nodesModal .tab-content').forEach(content => content.classList.remove('active'));
            
            const tabElement = document.querySelector(`[onclick="switchModalTab('${tabId}')"]`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            document.getElementById(tabId).classList.add('active');
        }
        
        function testSingleNode(type) {
            monitor.testSingleNode(type);
        }
        
        function saveCustomNode(type) {
            monitor.saveCustomNode(type);
        }
        
        function importData() {
            monitor.importData();
        }
        
        function closeModal() {
            monitor.closeModal();
        }
        
        function clearHistory() {
            monitor.clearHistory();
        }
        
        function clearLogs() {
            monitor.clearLogs();
        }
        
        // åˆå§‹åŒ–ç›‘æ§å™¨
        const monitor = new LatencyMonitor();
        
        // å…¨å±€å¯¼å‡º
        window.monitor = monitor;
        window.testSingleNode = testSingleNode;
        window.saveCustomNode = saveCustomNode;
        window.importData = importData;
        window.closeModal = closeModal;
        window.clearHistory = clearHistory;
        window.clearLogs = clearLogs;
        window.showTab = showTab;
        window.switchModalTab = switchModalTab;
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // é¡µé¢å¯è§æ€§å˜åŒ–
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    monitor.updateUI();
                }
            });
        });
    </script>
</body>
</html>
